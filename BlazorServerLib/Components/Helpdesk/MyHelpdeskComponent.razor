@inherits BlazorBusyComponentBaseModel

@using MudBlazor

<br />
<CascadingValue Value="SetTab">
    <TabSetComponent IsSilent="true" AsPills="true">
        <TabComponent SystemName="@(nameof(HelpdeskJournalModesEnum.ActualOnly))" Title="Открытые">
            <HelpdeskJournalComponent UserArea="UsersAreasHelpdeskEnum.Author" JournalMode="HelpdeskJournalModesEnum.ActualOnly" />
        </TabComponent>
        <TabComponent SystemName="@(nameof(HelpdeskJournalModesEnum.ArchiveOnly))" Title="Завершённые">
            <HelpdeskJournalComponent UserArea="UsersAreasHelpdeskEnum.Author" JournalMode="HelpdeskJournalModesEnum.ArchiveOnly" />
        </TabComponent>
        <TabComponent SystemName="@(nameof(HelpdeskJournalModesEnum.All))" Title="Все">
            <HelpdeskJournalComponent UserArea="UsersAreasHelpdeskEnum.Author" JournalMode="HelpdeskJournalModesEnum.All" />
        </TabComponent>
    </TabSetComponent>
</CascadingValue>

<CreateIssueComponent Update="Update" UserIdentityId="@user.UserId" />

@code {
    [Inject]
    AuthenticationStateProvider authRepo { get; set; } = default!;

    HelpdeskJournalComponent? _tab;
    UserInfoMainModel user = default!;

    void Update()
    {
        _tab?.TableRef.ReloadServerData();
    }

    void SetTab(HelpdeskJournalComponent page)
    {
        _tab = page;
    }

    protected override async Task OnInitializedAsync()
    {
        SetBusy();
        AuthenticationState state = await authRepo.GetAuthenticationStateAsync();
        IsBusyProgress = false;
        user = state.User.ReadCurrentUserInfo() ?? throw new Exception();
    }
}