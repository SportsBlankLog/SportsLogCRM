@rendermode @(new InteractiveServerRenderMode(prerender: false))

@using MudBlazor
@using System.Diagnostics

@inherits DocumentEditBaseComponent

@if (schemes is null || schemes.Length == 0)
{
    <figure>
        <blockquote class="blockquote">
            <p>Метаданные схемы документа не загружены.</p>
        </blockquote>
        <figcaption class="blockquote-footer">
            Схема данных <cite title="документа/схемы">@DocumentNameOrId</cite> отсутсвует
        </figcaption>
    </figure>
}
else if (schemes.Length > 1)
{
    <figure>
        <blockquote class="blockquote">
            <p>Коллизия имени метаданных схемы документа.</p>
        </blockquote>
        @foreach (DocumentSchemeConstructorModelDB _sc in schemes)
        {
            <figcaption class="blockquote-footer">
                <a href="@($"/journal-{_sc.Id}/project-{_sc.ProjectId}/document/{DocumentKey}")">@_sc.Name</a>
            </figcaption>
        }

    </figure>
}
else if (DocumentKey > 1 && session is null)
{
    <figure>
        <blockquote class="blockquote">
            <p>Сессия не найдена.</p>
        </blockquote>
        <figcaption class="blockquote-footer">
            Токен доступа не действителен.
        </figcaption>
    </figure>
}
else
{
    DocumentSchemeConstructorModelDB scheme_obj = schemes[0];
    scheme_obj.Tabs = scheme_obj.Tabs?.OrderBy(x => x.SortIndex).ToList();
    scheme_obj.Tabs?.ForEach(x => x.JoinsForms = x.JoinsForms?.OrderBy(y => y.SortIndex).ToList());

    DocumentMetadata.Tabs = DocumentMetadata.Tabs.OrderBy(x => x.SortIndex).ToList();
    DocumentMetadata.Tabs.ForEach(x => x.Forms = x.Forms.OrderBy(x => x.SortIndex).ToArray());

    <TabSetComponent>
        @for (int i = 0; i < DocumentMetadata.Tabs.Count; i++)
        {
            TabFitModel tab = DocumentMetadata.Tabs[i];
            TabOfDocumentSchemeConstructorModelDB tdb = scheme_obj.Tabs![i];
            <TabComponent @key="@($"{scheme_obj.Id}-{tab.SystemName}-{tdb.Id}")" Title="@tab.Name" SystemName='@tab.SystemName'>
                <CascadingValue Value="tdb">
                    <CascadingValue Value="scheme_obj">
                        <CascadingValue Value="DocumentMetadata">
                            <CascadingValue Value="tab">
                                <CascadingValue Value="DocumentKey">
                                    <CascadingValue Value="session">
                                        <TabOfDocumentConstructorComponent />
                                    </CascadingValue>
                                </CascadingValue>
                            </CascadingValue>
                        </CascadingValue>
                    </CascadingValue>
                </CascadingValue>
            </TabComponent>
        }
    </TabSetComponent>
}