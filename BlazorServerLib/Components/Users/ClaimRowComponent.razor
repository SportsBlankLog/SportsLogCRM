@inject IUsersProfilesService UsersProfilesRepo

@rendermode InteractiveServer

<tr>
    @if (isEdit)
    {
        <th scope="row" colspan="2">
            <div class="input-group input-group-sm mb-3">
                <span class="input-group-text" id="inputGroup-sizing-sm">Claim</span>
                <input @bind-value="claimType" @bind-value:event="oninput" type="text" placeholder="ClaimType" aria-label="Claim type" class="form-control">
                <input @bind-value="claimValue" @bind-value:event="oninput" type="text" placeholder="ClaimValue" aria-label="Claim value" class="form-control">
                <button @onclick="SaveClaim" disabled="@(CantSave || Claim.Equals(claimType, claimValue))" class="btn btn-outline-@(CantSave ? "secondary" : "success")" type="button" id="button-addon2">Сохранить</button>
            </div>
        </th>
    }
    else
    {
        <th scope="row">@Claim.ClaimType</th>
        <td>
            @Claim.ClaimValue
            <span class="ps-1 badge text-bg-primary my-btn" @onclick="() => { isEdit = true; }">edit</span>
            <span class="ps-1 badge text-bg-warning my-btn" @onclick="RemoveClaim">delete</span>
        </td>
    }
</tr>

@code {
    [Parameter, EditorRequired]
    public required ClaimBaseModel Claim { get; set; }

    [Parameter, EditorRequired]
    public ClaimAreasEnum ClaimArea { get; set; }

    [Parameter, EditorRequired]
    public required string OwnerId { get; set; }

    [Parameter, EditorRequired]
    public required Action ReloadHandler { get; set; }

    bool isEdit;
    string? claimType;
    string? claimValue;

    bool CantSave => string.IsNullOrWhiteSpace(claimType) || string.IsNullOrWhiteSpace(claimValue) || Claim.Equals(claimType, claimValue);

    protected override void OnInitialized()
    {
        claimType = Claim.ClaimType;
        claimValue = Claim.ClaimValue;
        base.OnInitialized();
    }

    async Task SaveClaim()
    {
        ResponseBaseModel res = await UsersProfilesRepo.ClaimUpdateOrCreate(ClaimModel.Build(Claim.Id, claimType, claimValue, OwnerId), ClaimArea);
        if (!res.Success())
            throw new Exception(res.Message());

        isEdit = false;
        ReloadHandler();
    }

    async Task RemoveClaim()
    {
        ResponseBaseModel res = await UsersProfilesRepo.ClaimDelete(ClaimArea, Claim.Id);
        if (!res.Success())
            throw new Exception(res.Message());

        ReloadHandler();
    }
}
